name: Tests
env:
    COLUMNS: 140 # Avoid narrow or even truncated output from pytest and rich
on:
    push:
        branches:
            - master
        tags:
            - "*"
        paths-ignore:
            - "**.md"
    pull_request:
        paths-ignore:
            - "**.md"

jobs:
    linux:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v6

            - name: set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: ".python-version"

            - name: setup uv
              uses: astral-sh/setup-uv@v7

            - name: lint, format and typecheck
              run: |
                  uv run ruff check
                  uv run ruff format --check
                  uv run pyright

            - name: pytest
              run: uv run pytest tests

    examples:
        runs-on: ubuntu-latest
        timeout-minutes: 4
        steps:
            - uses: actions/checkout@v6

            - name: Start Server
              run: |
                  cd tests/performance && nginx -p $PWD -c $PWD/nginx.conf
                  # timeout 10s sh -c 'until curl -s localhost:8080; do sleep 1; done'

            - name: set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: ".python-version"

            - name: setup uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true

            - name: Run Tests
              env:
                  OTEL_TRACES_EXPORTER: console
              run: |
                  uv run aiolocust examples/otel/instrument_aiohttpclient.py -d 1 | tee locust_output.txt
                  grep -E '"name": "GET"' locust_output.txt
                  # advanced
                  uv run aiolocust examples/otel/instrument_aiohttpclient_span_manipulation.py -d 1 | tee locust_output.txt
                  grep '"name": "some-name"' locust_output.txt
                  grep '"foo": "bar"' locust_output.txt
                  grep 'some-value' locust_output.txt

    perftest:
        runs-on: ubuntu-latest
        timeout-minutes: 4
        steps:
            - uses: actions/checkout@v6

            - name: Start Server
              run: |
                  cd tests/performance && nginx -p $PWD -c $PWD/nginx.conf
                  # timeout 10s sh -c 'until curl -s localhost:8080; do sleep 1; done'

            - name: set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: ".python-version"

            - name: setup uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true

            - name: Run Tests
              run: |
                  uv run aiolocust examples/advanced.py --users 100 --duration 60 | tee locust_output.txt
                  grep -E 'Total.*[0-9]{5}.[0-9]{2}/s' locust_output.txt # ensure >10000 RPS
                  bash -ec '! grep Traceback locust_output.txt' # ensure no callstacks
    windows:
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v6

            - name: set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: ".python-version"

            - name: setup uv
              uses: astral-sh/setup-uv@v7

            - name: pytest
              run: uv run pytest tests

    macos:
        runs-on: macos-latest

        steps:
            - uses: actions/checkout@v6

            - name: set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: ".python-version"

            - name: setup uv
              uses: astral-sh/setup-uv@v7

            - name: pytest
              run: uv run pytest tests

    publish_pypi:
        name: Publish to PyPI
        needs: [linux, windows, macos]
        if: github.repository_owner == 'cyberw' && startsWith(github.event.ref, 'refs/tags')
        runs-on: ubuntu-latest

        permissions:
            id-token: write
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Install uv
              uses: astral-sh/setup-uv@v7

            - name: Build package
              run: |
                  uv version ${{ github.ref_name }}
                  uv build

            - name: Publish to PyPI
              run: uv publish
